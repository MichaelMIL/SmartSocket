<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<title>SmartSocket Control</title>
<style>
* { box-sizing: border-box; }
body {
  font-family: Arial, sans-serif;
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  background-color: #f5f5f5;
}
.header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 10px 10px 0 0;
  text-align: center;
}
.nav {
  background: white;
  padding: 10px;
  border-bottom: 2px solid #667eea;
  display: flex;
  gap: 10px;
}
.nav button {
  flex: 1;
  padding: 10px;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
}
.nav button:hover {
  background: #5568d3;
}
.nav button.active {
  background: #764ba2;
}
.container {
  background: white;
  padding: 30px;
  border-radius: 0 0 10px 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.relay-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-top: 20px;
}
.relay-card {
  background: #f8f9fa;
  border: 2px solid #dee2e6;
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  transition: all 0.3s;
}
.relay-card.on {
  border-color: #00C000;
  background: #e8f5e9;
}
.relay-card.off {
  border-color: #C00000;
  background: #ffebee;
}
.relay-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 15px;
  color: #333;
}
.relay-status {
  font-size: 14px;
  margin-bottom: 15px;
  color: #666;
}
.relay-button {
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 5px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}
.relay-button.on {
  background-color: #00C000;
  color: white;
}
.relay-button.off {
  background-color: #C00000;
  color: white;
}
.relay-button:hover {
  opacity: 0.8;
  transform: scale(1.05);
}
.relay-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.status {
  margin-top: 20px;
  padding: 15px;
  border-radius: 5px;
  display: none;
}
.status.success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}
.status.error {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}
.status.info {
  background-color: #d1ecf1;
  color: #0c5460;
  border: 1px solid #bee5eb;
}
.page {
  display: none;
}
.page.active {
  display: block;
}
.progress {
  width: 100%;
  height: 20px;
  background-color: #f0f0f0;
  border-radius: 10px;
  overflow: hidden;
  margin-top: 10px;
  display: none;
}
.progress-bar {
  height: 100%;
  background-color: #4CAF50;
  width: 0%;
  transition: width 0.3s;
}
</style>
</head>
<body>
<div class='header'>
<h1>ðŸ”Œ SmartSocket Control Panel</h1>
</div>
<div class='nav'>
<button class='nav-btn active' onclick='showPage("control")'>Relay Control</button>
<button class='nav-btn' onclick='showPage("update")'>Firmware Update</button>
</div>
<div class='container'>
<div id='control-page' class='page active'>
<h2>Relay Control</h2>
<div class='relay-grid' id='relay-grid'></div>
<div class='status' id='status'></div>
</div>
<div id='update-page' class='page'>
<h2>Firmware Update</h2>
<form id='uploadForm' enctype='multipart/form-data'>
<div style='margin-bottom: 20px;'>
<label for='firmware' style='display: block; margin-bottom: 8px; font-weight: bold;'>Select Firmware File (.bin):</label>
<input type='file' id='firmware' name='firmware' accept='.bin' required style='width: 100%; padding: 10px; border: 2px dashed #ddd; border-radius: 5px;'>
</div>
<button type='submit' id='uploadBtn' style='width: 100%; padding: 12px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer;'>Upload & Update Firmware</button>
</form>
<div class='progress' id='progress'>
<div class='progress-bar' id='progressBar'></div>
</div>
<div class='status' id='update-status'></div>
</div>
</div>
<script>
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(page + '-page').classList.add('active');
  event.target.classList.add('active');
  if (page === 'control') {
    updateRelayStatus();
  }
}

function updateRelayStatus() {
  for (let i = 1; i <= 6; i++) {
    fetch('/api/relay/' + i)
      .then(r => {
        if (!r.ok && r.status === 503) {
          // Relay not initialized yet, will retry later
          return null;
        }
        return r.json();
      })
      .then(data => {
        if (data === null) {
          return; // Skip if service unavailable
        }
        const card = document.getElementById('relay-' + i);
        if (card) {
          if (data.success) {
            card.className = 'relay-card ' + (data.state ? 'on' : 'off');
            const btn = card.querySelector('.relay-button');
            if (btn) {
              btn.className = 'relay-button ' + (data.state ? 'on' : 'off');
              btn.textContent = data.state ? 'ON' : 'OFF';
              btn.disabled = false;
            }
            const statusEl = card.querySelector('.relay-status');
            if (statusEl) {
              statusEl.textContent = data.state ? 'Status: ON' : 'Status: OFF';
            }
          }
        }
      })
      .catch(err => {
        // Silently handle errors - relays may not be initialized yet
        console.debug('Relay ' + i + ' not available yet:', err.message);
      });
  }
}

function toggleRelay(id) {
  const card = document.getElementById('relay-' + id);
  if (!card) {
    console.error('Relay card ' + id + ' not found');
    return;
  }
  const btn = card.querySelector('.relay-button');
  if (!btn) {
    console.error('Relay button ' + id + ' not found');
    return;
  }
  btn.disabled = true;
  const currentState = btn.textContent === 'ON';
  fetch('/api/relay/' + id, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ state: !currentState })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      updateRelayStatus();
      showStatus('Relay ' + id + ' ' + (data.state ? 'turned ON' : 'turned OFF'), 'success');
    } else {
      showStatus('Error: ' + (data.error || 'Unknown error'), 'error');
      btn.disabled = false;
    }
  })
  .catch(err => {
    showStatus('Error: ' + err.message, 'error');
    btn.disabled = false;
  });
}

function showStatus(message, type) {
  const status = document.getElementById('status');
  if (status) {
    status.textContent = message;
    status.className = 'status ' + type;
    status.style.display = 'block';
    setTimeout(() => { status.style.display = 'none'; }, 3000);
  }
}

function showUpdateStatus(message, type) {
  const status = document.getElementById('update-status');
  if (status) {
    status.textContent = message;
    status.className = 'status ' + type;
    status.style.display = 'block';
  }
}

// Initialize relay grid when DOM is ready
function initRelayGrid() {
  const grid = document.getElementById('relay-grid');
  if (!grid) {
    console.error('Relay grid not found');
    return;
  }
  // Clear any existing content
  grid.innerHTML = '';
  // Create relay cards
  for (let i = 1; i <= 6; i++) {
    const card = document.createElement('div');
    card.id = 'relay-' + i;
    card.className = 'relay-card off';
    card.innerHTML = '<div class="relay-title">Relay ' + i + '</div><div class="relay-status">Status: OFF</div><button class="relay-button off" onclick="toggleRelay(' + i + ')">OFF</button>';
    grid.appendChild(card);
  }
  // Update status immediately
  updateRelayStatus();
}

// Initialize firmware upload form
function initFirmwareUpload() {
  const uploadForm = document.getElementById('uploadForm');
  if (!uploadForm) {
    console.error('Upload form not found');
    return;
  }
  uploadForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('firmware');
    const file = fileInput.files[0];
    if (!file) {
      showUpdateStatus('Please select a firmware file', 'error');
      return;
    }
    const formData = new FormData();
    formData.append('firmware', file);
    const uploadBtn = document.getElementById('uploadBtn');
    const progress = document.getElementById('progress');
    const progressBar = document.getElementById('progressBar');
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Uploading...';
    progress.style.display = 'block';
    progressBar.style.width = '0%';
    showUpdateStatus('Uploading firmware...', 'info');
    const xhr = new XMLHttpRequest();
    xhr.upload.addEventListener('progress', function(e) {
      if (e.lengthComputable) {
        const percentComplete = (e.loaded / e.total) * 100;
        progressBar.style.width = percentComplete + '%';
      }
    });
    xhr.addEventListener('load', function() {
      if (xhr.status === 200) {
        showUpdateStatus('Firmware uploaded successfully! Device will reboot...', 'success');
        setTimeout(() => { showUpdateStatus('Rebooting device...', 'info'); }, 2000);
      } else {
        showUpdateStatus('Upload failed: ' + xhr.responseText, 'error');
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload & Update Firmware';
        progress.style.display = 'none';
      }
    });
    xhr.addEventListener('error', function() {
      showUpdateStatus('Upload error occurred', 'error');
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Upload & Update Firmware';
      progress.style.display = 'none';
    });
    xhr.open('POST', '/update');
    xhr.send(formData);
  });
}

// Wait for DOM to be ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    initRelayGrid();
    initFirmwareUpload();
  });
} else {
  initRelayGrid();
  initFirmwareUpload();
}

// Update status every 2 seconds
setInterval(updateRelayStatus, 2000);
</script>
</body>
</html>

